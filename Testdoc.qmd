## This QMD file serves as a place to test code before applying it to the application. Has no actual production value; think of it as scratch paper.


```{r load-libraries}
library(tidyverse)
library(lubridate)
library(plotly)
```

```{r data-read}
testfile <- read.csv("Test_Data/markerexport1.csv", sep = ";") |>
  rename(
    "Start_Time" = "StartTime..MM.dd.yyyy.HH.mm.ss.fff.",
    "End_Time" = "EndTime..MM.dd.yyyy.HH.mm.ss.fff."
  ) |>
  select(-End_Time)
```

```{r change_column_format}
parse_date_with_millis <- function(date_string) {
  ymd_hms(date_string, tz = "UTC", quiet = TRUE)
}

testfile$Start_Time <- lubridate::fast_strptime(testfile$Start_Time, format = "%m/%d/%Y %H:%M:%OS", tz = "UTC")
testfile$End_Time <- lubridate::fast_strptime(testfile$End_Time, format = "%m/%d/%Y %H:%M:%OS", tz = "UTC")
```

```{r extract_milliseconds}
extract_seconds_milliseconds <- function(datetime_string) {
  str_extract(datetime_string, "\\d{2}\\.\\d{3}$")
}

# Apply the function to Start_Time and End_Time columns
testfile$Start_Seconds_Milliseconds <- sapply(testfile$Start_Time, extract_seconds_milliseconds)
testfile$End_Seconds_Milliseconds <- sapply(testfile$End_Time, extract_seconds_milliseconds)


testfile <- testfile |>
  mutate(
    Start_Seconds_Milliseconds = as.numeric(Start_Seconds_Milliseconds),
    End_Seconds_Milliseconds = as.numeric(End_Seconds_Milliseconds),
    Milliseconds_Difference = End_Seconds_Milliseconds - Start_Seconds_Milliseconds
  )
  
#### Below here is the important part.

extract_time <- function(datetime_string) {
  str_extract(datetime_string, "\\d{2}:\\d{2}:\\d{2}\\.\\d{3}")
}

# Apply the function to Start_Time column and create a new column
testfile <- testfile |>
  mutate(Start_Time_HHMMSSMS = sapply(Start_Time, extract_time))

# Function to convert HH:MM:SS.MS to milliseconds
convert_to_milliseconds <- function(time_string) {
  parts <- str_split(time_string, "[:.]")[[1]]
  hours <- as.numeric(parts[1])
  minutes <- as.numeric(parts[2])
  seconds <- as.numeric(parts[3])
  milliseconds <- as.numeric(parts[4])
  
  total_milliseconds <- (hours * 3600000) + (minutes * 60000) + (seconds * 1000) + milliseconds
  return(total_milliseconds)
}

# Apply the function to Start_Time_HHMMSSMS column and create a new column
testfile <- testfile |>
  mutate(Start_Time_HHMMSSMS = sapply(Start_Time, extract_time)) |>
  mutate(Start_Time_Milliseconds = sapply(Start_Time_HHMMSSMS, convert_to_milliseconds))
```

```{r final-streamlined-code}
extract_time <- function(datetime_string) {
  str_extract(datetime_string, "\\d{2}:\\d{2}:\\d{2}\\.\\d{3}")
}

# Apply the function to Start_Time column and create a new column
testfile <- testfile |>
  mutate(Start_Time_HHMMSSMS = sapply(Start_Time, extract_time))

# Function to convert HH:MM:SS.MS to milliseconds
convert_to_milliseconds <- function(time_string) {
  parts <- str_split(time_string, "[:.]")[[1]]
  hours <- as.numeric(parts[1])
  minutes <- as.numeric(parts[2])
  seconds <- as.numeric(parts[3])
  milliseconds <- as.numeric(parts[4])
  
  total_milliseconds <- (hours * 3600000) + (minutes * 60000) + (seconds * 1000) + milliseconds
  return(total_milliseconds)
}

# Apply the function to Start_Time_HHMMSSMS column and create a new column
testfile <- testfile |>
  mutate(Start_Time_HHMMSSMS = sapply(Start_Time, extract_time)) |>
  mutate(Start_Time_Milliseconds = sapply(Start_Time_HHMMSSMS, convert_to_milliseconds))
```

```{r acc-test}
acctest <- read.csv("Test_Data/AccelerometerTest.csv", sep = ";")

accgraph <- read.csv("Test_Data/Just_Accelerometer_for_Graph_Tests.csv", sep = ",")
```

```{r plotly-accelerometer}
acceleration_plotly <- plot_ly(accgraph, x = ~Time_Elapsed_MS) |>
  add_lines(y = ~IMUAccelerometerX, name = 'Accelerometer X', line = list(color = 'blue2', width = 2), opacity = 0.5) |>
  add_lines(y = ~IMUAccelerometerY, name = 'Accelerometer Y', line = list(color = 'purple', width = 2), opacity = 0.5) |>
  add_lines(y = ~IMUAccelerometerZ, name = 'Accelerometer Z', line = list(color = 'green', width = 2), opacity = 0.5) |>
  layout(
    title = 'Accelerometer Data',
    xaxis = list(title = 'Time Elapsed (ms)'),
    yaxis = list(title = 'Acceleration', range = c(-36000, 36000)),
    template = 'plotly_white'
  )

# Display the plot
acceleration_plotly
```

```{r ImpWav-Read}
ImpWav <- read.csv("Test_Data/Impedance-Waveform_Test.csv", sep = ",")
```

```{r ImpWav-Graph}
ImpWav_filtered_waveform <- ImpWav |> filter(!is.na(StimulationWaveform))
ImpWav_filtered_impedance <- ImpWav |> filter(!is.na(TransthoracicImpedance))

# Create the plot with both variables on different y-axes and specified settings
ImpWav_Plotly <- plot_ly() |>
  add_lines(
    x = ~ImpWav_filtered_waveform$Time_Elapsed_MS,
    y = ~ImpWav_filtered_waveform$StimulationWaveform,
    name = 'Stimulation Waveform',
    line = list(color = 'gold', opacity = 0.5),
    yaxis = 'y1'
  ) |>
  add_lines(
    x = ~ImpWav_filtered_impedance$Time_Elapsed_MS,
    y = ~ImpWav_filtered_impedance$TransthoracicImpedance,
    name = 'Transthoracic Impedance',
    line = list(color = 'green', opacity = 0.5),
    yaxis = 'y2'
  ) |>
  layout(
    yaxis = list(
      title = 'Stimulation Waveform',
      range = c(0, 8000),
      autorange = TRUE
    ),
    yaxis2 = list(
      title = 'Transthoracic Impedance',
      overlaying = 'y',
      side = 'right',
      standoff = 15,
      range = c(0, 8000),
      autorange = TRUE
    ),
    xaxis = list(title = 'Time Elapsed (MS)'),
    legend = list(orientation = 'h'),
    height = 900
  )

# Show the plot
ImpWav_Plotly

########### ggplot test:
# ImpWav |> filter(!is.na(StimulationWaveform)) |> 
#   ggplot(aes(x = Time_Elapsed_MS, y = StimulationWaveform)) +
#   geom_line()
# 
# ImpWav |> filter(!is.na(TransthoracicImpedance)) |> 
#   ggplot(aes(x = Time_Elapsed_MS, y = TransthoracicImpedance)) +
#   geom_line()

########### plotly plot:
```

